<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <link href='http://fonts.googleapis.com/css?family=Nobile' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Podkova' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Cousine' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" type="text/css" href="/css/reset.css" />
  <link rel="stylesheet" type="text/css" href="/css/syntax.css" />
  <link rel="stylesheet" type="text/css" href="/css/pygments-css/native.css" />
  <link rel="stylesheet" type="text/css" href="/css/webestylin.css" />

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      $('.highlight pre').toggle(function(event) {
        var codeBlock = $(event.target);
        codeBlock.data('originalWidth', codeBlock.width());
        codeBlock.animate({width: 1000});
      },
      function(event) {
        var codeBlock = $(event.target);
        codeBlock.animate({width: codeBlock.data('originalWidth')});
      }
      );
    });
  </script>

  <title>writeheavy</title>
</head>
<body>

<h1><a href="/">writeheavy</a></h1>
<div id="parappa">
  <div id="sideaction">
    <img src="http://www.gravatar.com/avatar/0af787d46e04d47117e6cf140fd19332.png?s=150" alt="moi" />
    <h4>Who?</h4>
    <p>I'm Paul Hinze.  I live in Chicago.  I'm a developer at <a href="http://braintreepayments.com">Braintree</a>.</p>
  </div>
  <div id="contentisking">
    
<div id="post">
  <h2><a href="/2011/05/23/when-its-ok-to-turn-of-rails-ip-spoof-checking.html">When it's okay to turn off Rails' IP spoof checking</a></h2>
  <div class="date">published 23 May 2011</div>
  <div class="postcontent">
  <p>When tracking down some stray 500s in our application, I started investigating messages like the following:</p>

<pre><code>/!\ FAILSAFE /!\  Sat May  11:12:54 -0400 2008
  Status: 500 Internal Server Error
  IP spoofing attack?!
HTTP_CLIENT_IP=&quot;67.195.44.101&quot;
HTTP_X_FORWARDED_FOR=&quot;67.195.44.101, 67.195.37.172&quot;</code></pre>

<p>Anything that hits the failsafe in Rails is generally Very Bad, because it means all of your normal in-app exception handling is not running. It&#8217;s implemented as a Rack middleware that sits at the top of the stack and rescues any exceptions raised further down:</p>
<div class='highlight'><pre><code class='ruby'><span class='lineno'>25</span> <span class='k'>def</span> <span class='nf'>call</span><span class='p'>(</span><span class='n'>env</span><span class='p'>)</span>
<span class='lineno'>26</span>   <span class='vi'>@app</span><span class='o'>.</span><span class='n'>call</span><span class='p'>(</span><span class='n'>env</span><span class='p'>)</span>
<span class='lineno'>27</span> <span class='k'>rescue</span> <span class='no'>Exception</span> <span class='o'>=&gt;</span> <span class='n'>exception</span>
<span class='lineno'>28</span>   <span class='c1'># Reraise exception in test environment</span>
<span class='lineno'>29</span>   <span class='k'>if</span> <span class='n'>defined?</span><span class='p'>(</span><span class='no'>Rails</span><span class='p'>)</span> <span class='o'>&amp;&amp;</span> <span class='no'>Rails</span><span class='o'>.</span><span class='n'>env</span><span class='o'>.</span><span class='n'>test?</span>
<span class='lineno'>30</span>     <span class='k'>raise</span> <span class='n'>exception</span>
<span class='lineno'>31</span>   <span class='k'>else</span>
<span class='lineno'>32</span>     <span class='n'>failsafe_response</span><span class='p'>(</span><span class='n'>exception</span><span class='p'>)</span>
<span class='lineno'>33</span>   <span class='k'>end</span>
<span class='lineno'>34</span> <span class='k'>end</span>
</code><a class='code-attribution' href='https://github.com/rails/rails/blob/v2.3.11/actionpack/lib/action_controller/failsafe.rb#L25-34'>actionpack/lib/action_controller/failsafe.rb (rails v2.3.11)</a></pre></div>
<h3 id='determining_the_cause_of_the_error'>Determining the Cause of the Error</h3>

<p>So we know that the IP spoof exception is coming from somewhere outside of normal application code. Luckily the message is pretty easy to grep for in the Rails source (thanks for using a &#8220;?!&#8221; guys), which brings us to this code:</p>

<p><div class='highlight'><pre><code class='ruby'><span class='lineno'>228</span> <span class='n'>remote_ips</span> <span class='o'>=</span> <span class='vi'>@env</span><span class='o'>[</span><span class='s1'>&#39;HTTP_X_FORWARDED_FOR&#39;</span><span class='o'>]</span> <span class='o'>&amp;&amp;</span> <span class='vi'>@env</span><span class='o'>[</span><span class='s1'>&#39;HTTP_X_FORWARDED_FOR&#39;</span><span class='o'>].</span><span class='n'>split</span><span class='p'>(</span><span class='s1'>&#39;,&#39;</span><span class='p'>)</span>
<span class='lineno'>229</span> 
<span class='lineno'>230</span> <span class='k'>if</span> <span class='vi'>@env</span><span class='o'>.</span><span class='n'>include?</span> <span class='s1'>&#39;HTTP_CLIENT_IP&#39;</span>
<span class='lineno'>231</span>   <span class='k'>if</span> <span class='no'>ActionController</span><span class='o'>::</span><span class='no'>Base</span><span class='o'>.</span><span class='n'>ip_spoofing_check</span> <span class='o'>&amp;&amp;</span> <span class='n'>remote_ips</span> <span class='o'>&amp;&amp;</span> <span class='o'>!</span><span class='n'>remote_ips</span><span class='o'>.</span><span class='n'>include?</span><span class='p'>(</span><span class='vi'>@env</span><span class='o'>[</span><span class='s1'>&#39;HTTP_CLIENT_IP&#39;</span><span class='o'>]</span><span class='p'>)</span>
<span class='lineno'>232</span>     <span class='c1'># We don&#39;t know which came from the proxy, and which from the user</span>
<span class='lineno'>233</span>     <span class='k'>raise</span> <span class='no'>ActionControllerError</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='o'>&lt;&lt;</span><span class='no'>EOM</span><span class='p'>)</span>
<span class='lineno'>234</span> <span class='sh'>IP spoofing attack?!</span>
<span class='lineno'>235</span> <span class='sh'>HTTP_CLIENT_IP=#{@env[&#39;HTTP_CLIENT_IP&#39;].inspect}</span>
<span class='lineno'>236</span> <span class='sh'>HTTP_X_FORWARDED_FOR=#{@env[&#39;HTTP_X_FORWARDED_FOR&#39;].inspect}</span>
<span class='lineno'>237</span> <span class='no'>EOM</span>
<span class='lineno'>238</span>   <span class='k'>end</span>
<span class='lineno'>239</span> 
<span class='lineno'>240</span>   <span class='k'>return</span> <span class='vi'>@env</span><span class='o'>[</span><span class='s1'>&#39;HTTP_CLIENT_IP&#39;</span><span class='o'>]</span>
<span class='lineno'>241</span> <span class='k'>end</span>
</code><a class='code-attribution' href='https://github.com/rails/rails/blob/v2.3.11/actionpack/lib/action_controller/request.rb#L228-241'>actionpack/lib/action_controller/request.rb (rails v2.3.11)</a></pre></div></p>

<p>Lines 228-231 are the key. If <code>HTTP_CLIENT_IP</code> shows up in the Rack environment, it must also show up in the <code>remote_ips</code> array, or else we blow up. The former is set by the the <code>Client-IP</code> header on the incoming request, and you can see that <code>remote_ips</code> is set by splitting the <code>X-Forwarded-For</code> header on commas.</p>

<h3 id='gaining_some_perspective'>Gaining some Perspective</h3>

<p>We now see what the code does, but what&#8217;s the context here? Why does Rails choose to freak out if these two headers are present and don&#8217;t match?</p>

<p>It looks like this issue should be pretty easy to reproduce. We just need to pass in bogus <code>Client-Ip</code> and <code>X-Forwarded-For</code> headers that don&#8217;t match and watch everything explode.</p>

<h3 id='reproducing_in_rails_23'>Reproducing in Rails 2.3</h3>

<p>First we&#8217;ll build up a clean project with a super-basic scaffold.</p>
<div class='inverse'>
<div class='highlight'><pre><code class='console'><span class='gp'>phinze:/tmp$</span> rvm use 1.9.2@ipspoof-twothree --create
<span class='go'>Using /Users/phinze/.rvm/gems/ruby-1.9.2-p180 with gemset ipspoof-twothree</span>

<span class='gp'>phinze:/tmp$</span> gem install rails -v 2.3.11 <span class='o'>&amp;&amp;</span> gem install sqlite3
<span class='go'>Successfully installed rails-2.3.11</span>
<span class='go'>...</span>

<span class='gp'>phinze:/tmp$</span> rails ipspoof-twothree <span class='o'>&amp;&amp;</span> <span class='nb'>cd </span>ipspoof-twothree
<span class='go'>create  app/controllers</span>
<span class='go'>create  app/helpers</span>
<span class='go'>create  app/models</span>
<span class='go'>...</span>

<span class='gp'>phinze:/tmp/ipspoof-twothree$</span> ./script/generate scaffold SomeModel
<span class='go'>      create    app/models/some_model.rb</span>
<span class='go'>...</span>

<span class='gp'>phinze:/tmp/ipspoof-twothree$</span> rake db:migrate
<span class='go'>(in /private/tmp/ipspoof-twothree)</span>
<span class='go'>==  CreateSomeModels: migrating ===============================================</span>
<span class='go'>-- create_table(:some_models)</span>
<span class='go'>   -&gt; 0.0009s</span>
<span class='go'>==  CreateSomeModels: migrated (0.0010s) ======================================</span>

<span class='gp'>phinze:/tmp/ipspoof-twothree$</span> ./script/server
<span class='go'>=&gt; Booting WEBrick</span>
<span class='go'>=&gt; Rails 2.3.11 application starting on http://0.0.0.0:3000</span>
<span class='go'>...</span>
</code></pre>
</div>
</div>
<p>Now we&#8217;re ready to test out our theory about how this can be reproduced. With the server running, we&#8217;ll cook up a simple request with telnet:</p>
<div class='inverse'>
<div class='highlight'><pre><code class='console'><span class='gp'>phinze:~$</span> telnet 127.0.0.1 3000
<span class='go'>Trying 127.0.0.1...</span>
<span class='go'>Connected to localhost.</span>
<span class='go'>Escape character is &#39;^]&#39;.</span>
<span class='go'>GET /some_models HTTP/1.1</span>
<span class='go'>Client-IP: 1.2.3.4</span>
<span class='go'>X-Forwarded-For: 2.3.4.5</span>

<span class='go'>HTTP/1.1 500 Internal Server Error</span>
<span class='go'>...</span>
</code></pre>
</div>
</div>
  </div>
  <!-- <a id="more" href="/2011/05/23/when-its-ok-to-turn-of-rails-ip-spoof-checking.html#disqus">Comments &raquo;</a> -->
</div>

<!--
<h2>archive</h2>
<ul id="archive">

<li><a href="/2011/05/23/when-its-ok-to-turn-of-rails-ip-spoof-checking.html">When it's okay to turn off Rails' IP spoof checking</a><abbr>23 May 2011</abbr></li>

</ul>
-->

  </div>
  <div class="clear"></div>
</div>

</body>
</html>
